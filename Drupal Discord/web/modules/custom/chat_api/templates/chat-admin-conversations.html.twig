{#
/**
 * @file
 * Professional Conversations Management Template.
 *
 * Available variables:
 * - conversations: Array of conversation objects with enriched data
 * - stats: Summary statistics
 */
#}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<div class="chat-admin-conversations">
  {# Page Header #}
  <div class="page-header">
    <div>
      <h1><i class="fas fa-comments"></i> {{ 'Conversation Management'|t }}</h1>
      <p class="subtitle">{{ 'View and monitor all chat conversations'|t }}</p>
    </div>
    <div class="header-actions">
      <a href="/admin/chat" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> {{ 'Back to Dashboard'|t }}
      </a>
    </div>
  </div>

  {# Summary Statistics #}
  <div class="users-stats">
    <div class="stat-box">
      <i class="fas fa-comments stat-icon"></i>
      <div class="stat-content">
        <div class="stat-value">{{ stats.total_conversations }}</div>
        <div class="stat-label">{{ 'Total Conversations'|t }}</div>
      </div>
    </div>
    <div class="stat-box">
      <i class="fas fa-user-friends stat-icon stat-icon--success"></i>
      <div class="stat-content">
        <div class="stat-value">{{ stats.private_conversations }}</div>
        <div class="stat-label">{{ 'Private Chats'|t }}</div>
      </div>
    </div>
    <div class="stat-box">
      <i class="fas fa-users stat-icon stat-icon--info"></i>
      <div class="stat-content">
        <div class="stat-value">{{ stats.group_conversations }}</div>
        <div class="stat-label">{{ 'Group Chats'|t }}</div>
      </div>
    </div>
    <div class="stat-box">
      <i class="fas fa-fire stat-icon stat-icon--danger"></i>
      <div class="stat-content">
        <div class="stat-value">{{ stats.active_today }}</div>
        <div class="stat-label">{{ 'Active Today'|t }}</div>
      </div>
    </div>
  </div>

  {# Conversations Table #}
  <div class="table-container">
    <div class="table-header">
      <h2><i class="fas fa-list"></i> {{ 'All Conversations'|t }}</h2>
      <div class="table-actions">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="conversationSearch" placeholder="{{ 'Search conversations...'|t }}">
        </div>
        <select id="typeFilter" class="filter-select">
          <option value="all">{{ 'All Types'|t }}</option>
          <option value="private">{{ 'Private Only'|t }}</option>
          <option value="group">{{ 'Group Only'|t }}</option>
        </select>
      </div>
    </div>

    {% if conversations|length > 0 %}
      <div class="table-responsive">
        <table class="users-table conversations-table">
          <thead>
            <tr>
              <th><i class="fas fa-hashtag"></i> {{ 'ID'|t }}</th>
              <th><i class="fas fa-comment-dots"></i> {{ 'Conversation'|t }}</th>
              <th><i class="fas fa-tag"></i> {{ 'Type'|t }}</th>
              <th><i class="fas fa-users"></i> {{ 'Participants'|t }}</th>
              <th><i class="fas fa-message"></i> {{ 'Last Message'|t }}</th>
              <th><i class="fas fa-envelope"></i> {{ 'Messages'|t }}</th>
              <th><i class="far fa-calendar"></i> {{ 'Created'|t }}</th>
              <th><i class="far fa-clock"></i> {{ 'Last Activity'|t }}</th>
              <th><i class="fas fa-cog"></i> {{ 'Actions'|t }}</th>
            </tr>
          </thead>
          <tbody>
            {% for conversation in conversations %}
              <tr class="conversation-row" data-type="{{ conversation.type }}" data-id="{{ conversation._id }}">
                <td class="conversation-id">
                  <strong>#{{ conversation.id }}</strong>
                </td>
                <td class="conversation-info">
                  {% if conversation.type == 'group' %}
                    <div class="conversation-avatar">
                      <i class="fas fa-users"></i>
                    </div>
                    <div class="conversation-details">
                      <span class="conversation-name">{{ conversation.name }}</span>
                      <div class="conversation-meta">
                        <i class="fas fa-hashtag"></i> {{ conversation._id|slice(0, 8) }}
                      </div>
                    </div>
                  {% else %}
                    <div class="conversation-avatar">
                      <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="conversation-details">
                      {% if conversation.participants|length > 0 %}
                        <span class="conversation-name">
                          {% for p in conversation.participants %}
                            {{ p.displayName }}{% if not loop.last %} & {% endif %}
                          {% endfor %}
                        </span>
                      {% else %}
                        <span class="conversation-name">{{ 'Private Chat'|t }}</span>
                      {% endif %}
                      <div class="conversation-meta">
                        <i class="fas fa-hashtag"></i> {{ conversation._id|slice(0, 8) }}
                      </div>
                    </div>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if conversation.type == 'group' %}
                    <span class="badge badge-info">
                      <i class="fas fa-users"></i> {{ 'Group'|t }}
                    </span>
                  {% else %}
                    <span class="badge badge-primary">
                      <i class="fas fa-user-friends"></i> {{ 'Private'|t }}
                    </span>
                  {% endif %}
                </td>
                <td class="participants-cell">
                  <div class="participants-list">
                    {% for participant in conversation.participants %}
                      <span class="participant-badge" title="Drupal ID: {{ participant.drupalId }}">
                        <i class="fas fa-user-circle"></i> {{ participant.displayName }}
                      </span>
                    {% endfor %}
                  </div>
                </td>
                <td class="last-message-cell">
                  <small>
                    {% if conversation.lastMessage %}
                      {{ conversation.lastMessage|slice(0, 40) }}{% if conversation.lastMessage|length > 40 %}...{% endif %}
                    {% else %}
                      <span class="text-muted">{{ 'No messages'|t }}</span>
                    {% endif %}
                  </small>
                </td>
                <td class="text-center">
                  <span class="badge badge-secondary">
                    <i class="fas fa-user"></i> {{ conversation.participantCount }}
                  </span>
                </td>
                <td class="text-center">
                  <span class="badge badge-success">
                    <i class="fas fa-envelope"></i> {{ conversation.messageCount }}
                  </span>
                </td>
                <td class="conversation-date">
                  <i class="far fa-calendar-alt"></i>
                  {{ conversation.createdAt|date('M d, Y') }}
                  <div class="date-time">{{ conversation.createdAt|date('H:i') }}</div>
                </td>
                <td class="conversation-date">
                  {% if conversation.lastMessageAt %}
                    <i class="far fa-clock"></i>
                    {{ conversation.lastMessageAt|date('M d, Y') }}
                    <div class="date-time">{{ conversation.timeAgo }}</div>
                  {% else %}
                    <span class="text-muted">{{ 'No messages'|t }}</span>
                  {% endif %}
                </td>
                <td class="actions-cell">
                  <div class="action-buttons">
                    <a href="/admin/chat/conversations/{{ conversation._id }}" class="btn-action btn-view" title="{{ 'View Details'|t }}">
                      <i class="fas fa-eye"></i>
                    </a>
                    <button class="btn-action btn-danger action-delete" data-conversation-id="{{ conversation._id }}" title="{{ 'Delete Conversation'|t }}">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      {# Pagination #}
      {{ pager }}
      
    {% else %}
      <div class="empty-state">
        <i class="fas fa-comments"></i>
        <p>{{ 'No conversations found'|t }}</p>
        <small>{{ 'Conversations will appear here when users start chatting'|t }}</small>
      </div>
    {% endif %}

  </div>

</div>
